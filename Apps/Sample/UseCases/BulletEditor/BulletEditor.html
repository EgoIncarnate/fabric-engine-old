<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">  
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
    <title>FABRIC - Bullet Editor</title> 
    
    <script type="text/javascript" src="../../../../ThirdParty/jQuery/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="../../../../ThirdParty/jQuery/jquery-ui-1.8.16.custom.min.js"></script>

    <link type="text/css" href="../../../../ThirdParty/jQuery/css/fabric/main.css" rel="stylesheet" />
    <link type="text/css" href="../../../../ThirdParty/jQuery/css/fabric/jquery-ui-1.8.16.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Ray.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLRenderTarget.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.WebSocket.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Persistence.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Bullet.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Selection.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Undo.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../../SceneGraph/Parsers/parseOBJ.js" charset="utf-8"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

<style type="text/css">
#sidebar {
  width:270px;
}  
#viewer {
  right:270px;
}
</style>
<script type="text/javascript">

function getUrlVars() {
  var vars = {};
  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
    vars[key] = value;
  });
  return vars;
}

FABRIC.SceneGraph.registerNodeType('WorkPlane', {
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
      color: new FABRIC.RT.rgb(0.1,0.1,0.1,0.4)
    });

    if(!options.cameraNode)
      throw("Options.cameraNode is not specified!");

    // create a color if there's nothing
    if(!options.materialNode)
      options.materialNode = scene.constructNode('WorkPlaneMaterial', {
        textureNode: scene.constructNode('Image', { url: '../../BasicDemos/Resources/layout_grid.png' }).pub,
        colorBlend: 0.0,
        disableOptions: [FABRIC.SceneGraph.OpenGLConstants.GL_CULL_FACE],
        enableOptions: [FABRIC.SceneGraph.OpenGLConstants.GL_BLEND],
        blendModeSfactor: FABRIC.SceneGraph.OpenGLConstants.GL_SRC_ALPHA,
        blendModeDfactor: FABRIC.SceneGraph.OpenGLConstants.GL_ONE_MINUS_SRC_ALPHA,
        parentEventHandler: scene.getSceneRedrawTransparentObjectsEventHandler()
      }).pub;
    if(!options.geometryNode)
      options.geometryNode = scene.constructNode('Plane', {
        width: 16.0,
        height: 10.0,
      }).pub;
      
    var workPlaneNode = scene.constructNode('Instance', options);
    var workPlaneTransformNode = scene.getPrivateInterface(workPlaneNode.pub.getTransformNode());
    var workPlaneTransformDGNode = workPlaneTransformNode.getDGNode();
    workPlaneTransformDGNode.addMember("standing","Boolean",true);
    workPlaneNode.addMemberInterface(workPlaneTransformDGNode, 'standing', true);

    // connect the workplane to the camera and its transform
    var cameraPriv = scene.getPrivateInterface(options.cameraNode);
    var cameraTransformNode = scene.getPrivateInterface(cameraPriv.pub.getTransformNode());
    var cameraTransformDGNode = cameraTransformNode.getDGNode();
    
    workPlaneTransformDGNode.setDependency(cameraTransformDGNode,'camera');
    
    workPlaneTransformDGNode.bindings.append(scene.constructOperator({
      operatorName: 'projectWorkPlane',
      entryFunctionName: 'projectWorkPlane',
      srcFile: 'KL/BulletEditor.kl',
      parameterLayout: [
        'self.globalXfo',
        'camera.globalXfo',
        'camera.target',
        'self.standing'
      ]
    }));

    return workPlaneNode;    
  }});

// load out custom shaders
FABRIC.SceneGraph.defineEffectFromFile('ToonMaterial', 'ToonShader.xml');
FABRIC.SceneGraph.defineEffectFromFile('WorkPlaneMaterial', 'WorkPlaneShader.xml');
FABRIC.SceneGraph.defineEffectFromFile('GroundPlaneMaterial', 'GroundPlaneShader.xml');

$(document).ready(function() {
  
  var scene = FABRIC.SceneGraph.createScene();
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer'),
    enableRaycasting: true,
    backgroundColor: FABRIC.RT.rgb(0.5,0.5,0.5)
  });
  //viewport.addPostProcessEffectShader(scene.constructNode('EdgeDetectionPostProcessEffect', {
  //}));
  
  // Create a camera to draw the scene from
  camera = scene.constructNode('TargetCamera', {
      nearDistance: 1,
      farDistance: 200,
      target: new FABRIC.RT.Vec3(0,2,0),
      position: new FABRIC.RT.Vec3(-1.8, 2.1, 7.93)
    });
  var cameraTransform = camera.getTransformNode();
  scene.constructNode('CameraManipulator', { targetNode: camera });
  viewport.setCameraNode(camera);

  var light = scene.constructNode('SpotLight', {
    position: new FABRIC.RT.Vec3(5,5,5),
    target: new FABRIC.RT.Vec3(0,0,0),
    farDistance: 50,
    coneAngle: Math.degToRad(30.0),
    castShadows: true
  });
  var shadowMapMaterial = scene.constructNode('ShadowMaterial');

  // create the world grid
  scene.constructNode('Instance', {
    geometryNode: scene.constructNode('Plane', {
      width: 100.0,
      length: 100.0,
    }),
    materialNode: scene.constructNode('GroundPlaneMaterial', {
      color: FABRIC.RT.rgb(0.7,0.7,0.7),
      lightNode: light,
      step: 0.02,
      brightColor: FABRIC.RT.rgba(0.6,0.6,0.6,1),
      darkColor: FABRIC.RT.rgba(0.4,0.4,0.4,1),
    })
  });
  
  var workPlane = scene.constructNode('WorkPlane', {
    cameraNode: camera
  });

  //==========================================================
  // UNDO
  var undoManager = scene.constructManager('UndoManager');
  $("#undo").button().click(function(){
    undoManager.undo();
    viewport.redraw();
  });
  $("#redo").button().click(function(){
    undoManager.redo();
    viewport.redraw();
  });

  //==========================================================
  // SELECTION
  var selectionManager = scene.constructManager('ViewportSelectionManager', { undoManager: undoManager} );
  var selectionManipulationManager = scene.constructManager('SelectionManipulationManager', {
    selectionManager: selectionManager,
    transformGetter: 'getInitialTransform',
    transformSetter: 'setInitialTransform',
    screenTranslationRadius: 0.35
  });
  /*
  // TODO: ROTATION MANIPULATOR IS BROKEN, SEE SECOND TODO COMMENT IN HERE
  selectionManipulationManager.addManipulator(scene.constructNode('RotationManipulator',{
    parentNode: selectionManipulationManager.getTransformNode(),
    color: FABRIC.RT.rgb(0, 0.8, 0, 1),
    radius: 2.0
  }));
  */
  
  //==========================================================
  // MATERIALS + GEOMETRY
  var geometryNodes = {};
  var materialNodes = {};
  geometryNodes['primitiveCube'] = scene.constructNode('Cuboid', {
    length: 1.0,
    width: 1.0,
    height: 1.0
  });
  geometryNodes['primitiveFlat'] = scene.constructNode('Cuboid', {
    length: 3.0,
    width: 0.5,
    height: 1.0
  });
  geometryNodes['primitiveHigh'] = scene.constructNode('Cuboid', {
    length: 0.25,
    width: 2.0,
    height: 0.25
  });
  materialNodes['primitiveCube'] = scene.constructNode('ToonMaterial', {
    lightNode: light,
    darkColor: FABRIC.RT.rgb(165/255,118/255,74/255),
    brightColor: FABRIC.RT.rgb(201/255,168/255,117/255),
    colorSteps: 8.0
  });
  materialNodes['primitiveFlat'] = scene.constructNode('ToonMaterial', {
    lightNode: light,
    darkColor: FABRIC.RT.rgb(35/255,52/255,72/255),
    brightColor: FABRIC.RT.rgb(81/255,96/255,115/255),
    colorSteps: 8.0
  });
  materialNodes['primitiveHigh'] = scene.constructNode('ToonMaterial', {
    lightNode: light,
    darkColor: FABRIC.RT.rgb(127/255,49/255,45/255),
    brightColor: FABRIC.RT.rgb(176/255,125/255,122/255),
    colorSteps: 8.0
  });

  var highlightMaterial = scene.constructNode('ToonMaterial', {
    lightNode: light,
    darkColor: FABRIC.RT.rgb(77/255,159/255,70/255),
    brightColor: FABRIC.RT.rgb(207/255,255/255,203/255),
    colorSteps: 8.0
  });
  
  //==========================================================
  // BULLET LOGIC
  var worldNode = scene.constructNode('BulletWorldNode', {
    groundPlaneSize: 100,
    substeps: 6,
    createGroundPlaneGrid: false
  });
  
  // create all collision shapes
  var scalings = {};
  scalings['primitiveCube'] = new FABRIC.RT.Vec3(0.5,0.5,0.5);
  scalings['primitiveFlat'] = new FABRIC.RT.Vec3(1.5,0.5,0.25);
  scalings['primitiveHigh'] = new FABRIC.RT.Vec3(0.125,0.125,1.0);
  var masses = {};
  masses['primitiveCube'] = 1.0;
  masses['primitiveFlat'] = 2.0;
  masses['primitiveHigh'] = 0.25;
  for(var id in scalings)
    worldNode.addShape(id,FABRIC.RT.BulletShape.createBox(scalings[id]));

  var ws = false;
  var isPlaying = false;
  var rigidBodies = {};
  var rigidBodyCount = 0;
  var messagesToProcess = [];

  // serialize the rigid body data
  var getRigidBodyJsonData = function(bodies, skipName) {
    var data = {};
    for(var key in bodies) {
      data[bodies[key].name] = {};
      if(!skipName) {
        data[bodies[key].name].name = bodies[key].name;
      }
      data[bodies[key].name].type = bodies[key].type;
      data[bodies[key].name].transform = bodies[key].transformNode.getGlobalXfo();
    }
    return data;
  };

  // constuct a single body
  function constructRigidBody(type,xfo,name,notify) {
    if(!xfo) xfo = new FABRIC.RT.Xfo();
    if(!name) name = type+'_'+rigidBodyCount;
    if(rigidBodies[name])
      return rigidBodies[name];
    
    var body = new FABRIC.RT.BulletRigidBody({
      transform: xfo
    });
    
    var transform = scene.constructNode('BulletRigidBodyTransform', {
      bulletWorldNode: worldNode,
      name: name,
      shapeName: type,
      rigidBody: new FABRIC.RT.BulletRigidBody({
          transform: xfo,
          friction: 0.99,
          restitution: 0.05,
          mass: masses[type]
      }),
      createBulletRaycastEventHandler: false
    });
    transform.setInitialTransform(xfo);
    
    var instance = scene.constructNode('SelectableInstance', {
      name: name+"_Instance",
      geometryNode: geometryNodes[type],
      materialNode: materialNodes[type],
      transformNode: transform,
      enableRaycasting: true,
      highlightMaterial: highlightMaterial,
      selectMaterial: highlightMaterial,
      removeMainMaterial: true
    });
    instance.setSelectable(false);
    instance.setMaterialNode(shadowMapMaterial);

    // store it to the map    
    rigidBodies[name] = {};
    rigidBodies[name].name = name;
    rigidBodies[name].type = type;
    rigidBodies[name].transformNode = transform;
    rigidBodies[name].transform = xfo;
    rigidBodies[name].instance = instance;
    rigidBodies[name].world = worldNode;
    
    if(ws && notify) {
      ws.sendMessage('rigidBodiesCreated', getRigidBodyJsonData({name: rigidBodies[name]}));
    }
    rigidBodyCount++;
    
    return rigidBodies[name];
  }
  
  var processRigidBodyMessages = function(messages){
    var result = {};
    for(var i=0;i<messages.length;i++) {
      var message = messages[i];
      if(message.action == 'rigidBodiesCreated') {
        for(var key in message.data) {
          var newBody = constructRigidBody(
            message.data[key].type,
            message.data[key].transform,
            message.data[key].name,
            false
          );
          newBody.instance.setSelectable(true);
          result[key] = newBody;
        }
      }
      else if(message.action == 'rigidBodiesMoved') {
        for(var key in message.data) {
          var body = rigidBodies[message.data[key].name];
          if(!body)
            continue;
          body.transformNode.setInitialTransform(message.data[key].transform);
        }
      }
    }
    viewport.redraw();
    return result;
  };
  
  // construct a couple of sample cubes
  constructRigidBody('primitiveCube',new FABRIC.RT.Xfo({
    tr: new FABRIC.RT.Vec3(-3,0.5,0),
    ori: new FABRIC.RT.Quat().setFromAxisAndAngle(new FABRIC.RT.Vec3(0,1,0),0.3)
  })).instance.setSelectable(true);
  constructRigidBody('primitiveCube',new FABRIC.RT.Xfo({
    tr: new FABRIC.RT.Vec3(-3,1.5,0),
    ori: new FABRIC.RT.Quat().setFromAxisAndAngle(new FABRIC.RT.Vec3(0,1,0),1.4)
  })).instance.setSelectable(true);
  constructRigidBody('primitiveCube',new FABRIC.RT.Xfo({
    tr: new FABRIC.RT.Vec3(-3,2.5,0),
    ori: new FABRIC.RT.Quat().setFromAxisAndAngle(new FABRIC.RT.Vec3(0,1,0),0.7)
  })).instance.setSelectable(true);
  
  //===============================================================
  // WEBSOCKETS
  $("#join").button();
  try{
    ws = scene.constructManager("WebSocketManager", {
      serverUrl: 'ec2-50-19-205-12.compute-1.amazonaws.com',
      contextID: getUrlVars()['context'],
      onOpenCallBack: function() {

        // setup the invite link        
        $("#joinSession").html(ws.getContextID());
        
        // setup the join button
        $("#join").button().click(function(){
          viewport.hide();
          $('#joinDialog').dialog({
            modal: true
          });
          $('#joinCancel').button().click(function(){
            $('#joinDialog').dialog('close');
            viewport.show();
          });
          $('#joinOK').button().click(function(){
            if($('#joinContext').val())
              document.location.href = document.URL.split('?')[0]+"?context="+$('#joinContext').val();
            $('#joinDialog').dialog('close');
            viewport.show();
          });
        });

        // finally, let's fire the first event to let people know we exist!
        setTimeout(function(){
          // also, ask for all other participant
          ws.sendMessage('queryParticipants',{});
        }, 50);
      }
    });
    
    // colors
    var colors = [];
    colors.push(FABRIC.RT.rgb(0.0,0.75,0.0));
    colors.push(FABRIC.RT.rgb(0.75,0.0,0.0));
    colors.push(FABRIC.RT.rgb(0.75,0.0,0.75));
    colors.push(FABRIC.RT.rgb(0.0,0.75,0.75));
    colors.push(FABRIC.RT.rgb(0.0,0.0,0.75));

    // setup self in the participants map
    var participants = {};
    var participantsCount = 0;
    participants['_self'] = {};
    participants['_self'].name = 'Yourself';
    participants['_self'].color = colors[participantsCount % 5];
    participantsCount++;
    
    // setup a function to fill the camera list
    function updateParticipantsList() {
      var html = "";

      for(var key in participants)
        html += "<option value='"+key+"' style='color: white; background-color:rgb("+
          parseInt(participants[key].color.r * 255)+","+
          parseInt(participants[key].color.g * 255)+","+
          parseInt(participants[key].color.b * 255)+")'>"+participants[key].name+"</option>";
      
      // attach an on-select event to the camera list 
      $('#participantList').html(html);
    }
    updateParticipantsList();
    
    // setup a function to update the username
    $('#participantName').change(function(ui){
      participants['_self'].name = $('#participantName').val();
      ws.sendMessage('setParticipantName',participants['_self'].name);
      updateParticipantsList();
    });
    
    // setup a function to add a participant
    function addParticipant(id,name) {
      if(participants[id] == undefined) {
        
        // create a new participant
        var newParticipant = {};
        newParticipant.name = name;
        newParticipant.color = colors[participantsCount % 5];

        participants[id] = newParticipant;
        updateParticipantsList();
        participantsCount++;
        updateParticipantsList();
      }
    }

    // setup the function to be called when we receive a participant name change event
    ws.addMessageCallBack('setParticipantName', function(message) {

      if(message.sourceID == message.targetID)
        return;
      
      setTimeout(function(){
        addParticipant(message.sourceID,message.data);
        participants[message.sourceID].name = message.data;
        updateParticipantsList();
      }, 100);
    });
    
    // setup the function to be called when we receive a queryParticipants event
    ws.addMessageCallBack('queryParticipants', function(message) {
      if(message.sourceID == message.targetID)
        return;

      addParticipant(message.sourceID,'unknown');

      // notify the called of our name
      if(participants['_self'].name != 'Yourself')
        ws.sendMessage('setParticipantName',participants['_self'].name,message.sourceID);
      else
        ws.sendMessage('setParticipantName','unknown',message.sourceID);
        
      // send all rigid body data
      ws.sendMessage('rigidBodiesCreated',getRigidBodyJsonData(rigidBodies));
      ws.sendMessage('rigidBodiesMoved',getRigidBodyJsonData(rigidBodies));
    });
    
    // for created rigid bodies
    ws.addMessageCallBack('rigidBodiesCreated', function(message) {
      if(message.sourceID == message.targetID)
        return;
      if(isPlaying)
        messagesToProcess.push(message);
      else
        processRigidBodyMessages([message]);
    });

    // for created moved bodies
    ws.addMessageCallBack('rigidBodiesMoved', function(message) {
      if(message.sourceID == message.targetID)
        return;
      if(isPlaying)
        messagesToProcess.push(message);
      else
        processRigidBodyMessages([message]);
    });
    
    // ensure to send message for manipulated rigid bodies
    selectionManager.addEventListener('groupTransformChanged', function(evt){
      var bodiesToSave = {};
      for(var i=0;i<evt.selection.length;i++) {
        var key = evt.selection[i].getTransformNode().getName();
        bodiesToSave[key] = {};
        bodiesToSave[key].name = rigidBodies[key].name,
        bodiesToSave[key].type = rigidBodies[key].type,
        bodiesToSave[key].transform = rigidBodies[key].transformNode.getInitialTransform()
      }
      ws.sendMessage("rigidBodiesMoved",bodiesToSave);
    });
    
  }catch(e){
    // setup the join button
    $('#participants').html('');
    $('#joinMessage').html("<b style='color:#FF0000'>Error</b>: "+e+"<br>Currently only Google Chrome supports WebSocket natively.");
    $("#join").button().click(function(){
      viewport.hide();
      $('#joinDialog').dialog({
        modal: true
      });
      $('#joinCancel').button().click(function(){
        $('#joinDialog').dialog('close');
        viewport.show();
      });
      $('#joinOK').button().click(function(){
        $('#joinDialog').dialog('close');
        viewport.show();
      });
    });
  }

  //==========================================================
  // PLAYBACK CONTROL
  $('#play').button({
    text: true,
    icons: {
      primary: 'ui-icon-play'
    }
  }).click(function() {
    var options;
    workPlane.setDrawToggle(isPlaying);
    if(!isPlaying) {
      $(this).button('option', {
        label: 'Pause',
        icons: {
          primary: 'ui-icon-pause'
        }
      });
      isPlaying = true;
      selectionManager.setEnabled(false);
      scene.animation.play();
    } else {
      $(this).button('option', {
        label: 'Play',
        icons: {
          primary: 'ui-icon-play'
        }
      });
      scene.animation.pause();
      selectionManager.setEnabled(true);
      
      setTimeout(function(){
        scene.animation.setTime(0);
        viewport.redraw();
        processRigidBodyMessages(messagesToProcess);
        messagesToProcess = [];
        isPlaying = false;
      },10);
    }
  });
  
  //==========================================================
  // UI LOGIC
  function alignCameraWithAxes(alignX,alignY,alignZ) {
    var targetPos = cameraTransform.getTarget();
    var xfo = cameraTransform.getGlobalXfo();
    var distance = targetPos.subtract(xfo.tr).length();
    if(alignX) xfo.tr.x = targetPos.x + 0.0001;
    if(alignY) xfo.tr.y = targetPos.y;
    if(alignZ) xfo.tr.z = targetPos.z;
    xfo.tr = xfo.tr.subtract(targetPos).unit().multiplyScalar(distance).add(targetPos);
    xfo.ori.setFromDirectionAndUpvector(xfo.tr.subtract(targetPos),new FABRIC.RT.Vec3(0,1,0));
    cameraTransform.setGlobalXfo(xfo);
    viewport.redraw();
  }
  $('#workplaneXY').button().click(function() {
    alignCameraWithAxes(true,true,false);
  });
  $('#workplaneYZ').button().click(function() {
    alignCameraWithAxes(false,true,true);
  });
  $('#workplaneXZ').button().click(function() {
    alignCameraWithAxes(true,false,true);
  });
  $('#workplaneStand').button().click(function() {
    workPlane.setStanding(!workPlane.getStanding());
    viewport.redraw();
  });
  $('#workplaneblend').slider({
    min: 0.0,
    max: 1.0,
    step: 0.01,
    value: workPlane.getMaterialNode().getColorBlend()
  }).bind('slide',
    function(event, ui) {
      workPlane.getMaterialNode().setColorBlend(ui.value);
      viewport.redraw();
    }
  );
  
  // setup the help dialog
  $("#help").button().click(function(){
    viewport.hide();
    $('#helpDialog').dialog({
      modal: true
    });
    $('#helpOK').button().click(function(){
      $('#helpDialog').dialog('close');
      viewport.show();
    });
  });

  // setup load and save
  $("#presetSave").button().click(function(){
    var bodiesToSave = {};
    if(selectionManager.getSelection().length == 0) {
      bodiesToSave = getRigidBodyJsonData(rigidBodies,true);
    } else {
      for(var i=0;i<selectionManager.getSelection().length;i++) {
        var key = selectionManager.getSelection()[i].getTransformNode().getName();
        bodiesToSave[key] = {};
        bodiesToSave[key].type = rigidBodies[key].type,
        bodiesToSave[key].transform = rigidBodies[key].transformNode.getGlobalXfo()
      }
    }

    var path = scene.IO.queryUserFileAndFolderHandle(scene.IO.forOpenWithWriteAccess, "Bullet Editor Data", "json", "bulletScene");
    scene.IO.putTextFile(JSON.stringify(bodiesToSave), path);
  });
  $("#presetLoad").button().click(function(){
    var path = scene.IO.queryUserFileAndFolderHandle(scene.IO.forOpen, "Bullet Editor Data", "json", "bulletScene");
    var jsonData = JSON.parse(scene.IO.getTextFile(path));
    var newBodies = processRigidBodyMessages([{action: 'rigidBodiesCreated', data: jsonData}]);
    selectionManager.clearSelection();
    var selection = [];
    for(var key in newBodies) {
      selection.push(newBodies[key].instance);
    }
    selectionManager.select(selection);
    if(ws) {
      ws.sendMessage("rigidBodiesCreated",newBodies);
    }
    viewport.redraw();
  });
  $("#presetDuplicate").button().click(function(){
    if(selectionManager.getSelection().length == 0)
      return;
    var bodiesToSave = {};
    for(var i=0;i<selectionManager.getSelection().length;i++) {
      var key = selectionManager.getSelection()[i].getTransformNode().getName();
      bodiesToSave[key] = {};
      bodiesToSave[key].type = rigidBodies[key].type,
      bodiesToSave[key].transform = rigidBodies[key].transformNode.getGlobalXfo()
    }
    var newBodies = processRigidBodyMessages([{action: 'rigidBodiesCreated', data: bodiesToSave}]);
    selectionManager.clearSelection();
    var selection = [];
    for(var key in newBodies) {
      selection.push(newBodies[key].instance);
    }
    selectionManager.select(selection);
    if(ws) {
      ws.sendMessage("rigidBodiesCreated",newBodies);
    }
    viewport.redraw();
  });
  
  //===========================================================
  // DRAG AND DROP
  $("#primitiveCube").draggable();
  $("#primitiveFlat").draggable();
  $("#primitiveHigh").draggable();
  
  var dragStatus = {};
  var originalOffset = {};
  
  // setup a function for dragging a 3d rigid body
  var currentRigidBody = undefined;
  var dragConstructedRigidBody = function(evt) {
    if(!currentRigidBody)
      return;
    
    // construct an artifical rayEvent
    var rayEvt = {
      offsetX: evt.pageX,
      offsetY: evt.pageY,
      target: {
        clientWidth: $('#FabricContainer').width()
      }
    };
    
    var planeXfo = workPlane.getTransformNode().getGlobalXfo();
    var cameraXfo = cameraTransform.getGlobalXfo();
    var target = cameraTransform.getTarget();
    var rayData = viewport.rayCast(rayEvt).rayData;
    var distance = FABRIC.RT.Vec3.rayIntersectPlane(rayData.start,rayData.direction,target,planeXfo.ori.getYaxis());
    var xfo = new FABRIC.RT.Xfo();
    xfo.tr = rayData.start.add(rayData.direction.multiplyScalar(distance));
    if(evt.shiftKey) {
      xfo.tr = planeXfo.ori.inverse().rotateVector(xfo.tr.subtract(target));
      xfo.tr.x = Math.floor(xfo.tr.x+0.5)-0.5;
      xfo.tr.y = Math.floor(xfo.tr.y+0.5)-0.5;
      xfo.tr = planeXfo.ori.rotateVector(xfo.tr.add(target));
    }
    xfo.tr.y = xfo.tr.y < scalings[currentRigidBody.type].z ? scalings[currentRigidBody.type].z : xfo.tr.y;

    xfo.ori.setFromDirectionAndUpvector(new FABRIC.RT.Vec3(0,1,0),planeXfo.ori.getYaxis());
    // TODO: this is not working right
    
    worldNode.setRigidBodyInitialTransform(currentRigidBody.name,xfo);
    currentRigidBody.transform = xfo;
    
    if(ws)
      ws.sendMessage("rigidBodiesMoved",{name: currentRigidBody});
    
    viewport.redraw();
  };
  
  // define the viewport as a drop target
  $("#FabricContainer").droppable({
    over: function(evt) {
      if(isPlaying)
        return;
      var id = evt.srcElement.getAttribute('id');
      if(dragStatus[id] != 'outside')
        return;
      dragStatus[id] = 'inside';
      
      // update the evt data
      currentRigidBody = constructRigidBody(id,undefined,undefined,true);
      
      dragConstructedRigidBody(evt);
      document.addEventListener('mousemove',dragConstructedRigidBody);
    },
    drop: function(evt) {
      if(isPlaying)
        return;
      var id = evt.srcElement.getAttribute('id');
      if(dragStatus[id] != 'inside')
        return;

      // actual drop
      document.removeEventListener('mousemove',dragConstructedRigidBody);
      if(currentRigidBody)
        currentRigidBody.instance.setSelectable(true);
      currentRigidBody = undefined;
    },
    activate: function(evt) {
      // store the element's offset
      var id = evt.srcElement.getAttribute('id');
      originalOffset[id] = $("#"+id).offset();
      dragStatus[id] = 'outside';
      selectionManager.setEnabled(false);
    },
    deactivate: function(evt) {
      // restore the element's offset
      var id = evt.srcElement.getAttribute('id');
      $("#"+id).offset(originalOffset[id]);
      dragStatus[id] = undefined;
      selectionManager.setEnabled(true);
    }
  });
  
  $('#loadingDialog').dialog({
    modal: true
  });
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight) {
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if (nbRemaining===0) {
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      viewport.redraw();
      return true;
    }
  });
});

// jQuert UI Styling classes
$(document).ready(function() {
	$(".box").addClass("ui-widget");
	$(".box h2").addClass("ui-widget-header ui-corner-all");
	$(".content").addClass("ui-widget-content");
});

</script>

  </head> 
  <body style="padding: 10px">
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div style="display: none" id="joinDialog" title="Joining Session...">
      <h4 id="joinDesc"></h4>
      <div id='joinMessage'>
        Your current sessionID is: <b id="joinSession"></b><br>
        <input id="joinContext" type=text/><br>
        Enter the new sessionID and click OK to join a new session (restart appplication)<br>
      </div>
      <button id="joinCancel">Cancel</button>
      <button id="joinOK">OK</button>
    </div>
    <div style="display: none; width: 200px; height: 340px" id="helpDialog" title="Help">
      <h4>Bullet Editor Help</h4>
      Drag and drop the primitives on the side panel slowly onto the 3D viewport to create new rigid bodies.
      They will be places on the working plane. You can move the working plane by scrolling your mousewheel
      and pressing ALT at the same time.<br><br>
      IconA: asdasdasdadad<br>
      IconB: asdasdasdadad<br>
      IconC: asdasdasdadad<br>
      IconD: asdasdasdadad<br>
      IconE: asdasdasdadad<br>
      IconF: asdasdasdadad<br>
      <button id="helpOK">OK</button>
    </div>
    <div id="wrapper">
      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          <div class="box">
            <h2>CONTROLS</h2>
            <div class="content">
              <div id="workplaneblend" style="margin-bottom: 5px"></div>
              <button id="workplaneXY">X-Y</button>
              <button id="workplaneYZ">Y-Z</button>
              <button id="workplaneXZ">X-Z</button>
              <button id="workplaneStand">FIX</button><br><br>
              <button id="play">Play</button>
              <button id="help">Help</button>
              <button id='join'>Join</button><br>
              <button id='presetSave'>Save</button>
              <button id='presetLoad'>Load</button>
              <button id='presetDuplicate'>Dupl</button><br>
              <button id='undo'>Undo</button>
              <button id='redo'>Redo</button>
            </div><!--content-->
            <h2>PRIMITIVES</h2>
            <div class="content">
              <div id="primitiveCube" style="display: inline-block; margin: 2px; width: 50px; height: 50px; background-image:url(../../BasicDemos/Resources/wood1.png)"></div>
              <div id="primitiveFlat" style="display: inline-block; margin: 2px; width: 150px; height: 25px; background-image:url(../../BasicDemos/Resources/wood2.png)"></div>
              <div id="primitiveHigh" style="display: inline-block; margin: 2px; width: 50px; height: 100px; background-image:url(../../BasicDemos/Resources/wood3.png)"></div>
            </div><!--content-->
            <div id="participants">
              <h2>PARTICIPANTS</h2>
              <div class="content">
                <input id="participantName" type=text/ value='Yourself' style='width: 194px'><br>
                <select multi size=4 disabled id='participantList' style='width: 200px; margin-top: 10px'>
                </select><br>
              </div><!--content-->
            </div>
          </div><!--box-->
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->  </body> 
  </html>
