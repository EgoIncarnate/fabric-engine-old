<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">  
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
    <title>FABRIC - Bullet Editor</title> 
    
    <script type="text/javascript" src="../../../../ThirdParty/jQuery/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="../../../../ThirdParty/jQuery/jquery-ui-1.8.16.custom.min.js"></script>

    <link type="text/css" href="../../../../ThirdParty/jQuery/css/fabric/main.css" rel="stylesheet" />
    <link type="text/css" href="../../../../ThirdParty/jQuery/css/fabric/jquery-ui-1.8.16.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Ray.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.WebSocket.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Persistence.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Bullet.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Selection.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../../SceneGraph/Parsers/parseOBJ.js" charset="utf-8"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

<style type="text/css">
#sidebar {
  width:280px;
}  
#viewer {
  right:280px;
}
</style>
<script type="text/javascript">

function getUrlVars() {
  var vars = {};
  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
    vars[key] = value;
  });
  return vars;
}

FABRIC.SceneGraph.registerNodeType('WorkPlane', {
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
      color: new FABRIC.RT.rgb(0.1,0.1,0.1,0.4)
    });

    if(!options.cameraNode)
      throw("Options.cameraNode is not specified!");

    // create a color if there's nothing
    if(!options.materialNode)
      options.materialNode = scene.constructNode('WorkPlaneMaterial', {
        textureNode: scene.constructNode('Image', { url: '../../BasicDemos/Resources/layout_grid.png' }).pub,
        colorBlend: 0.4,
        disableOptions: [FABRIC.SceneGraph.OpenGLConstants.GL_CULL_FACE],
        enableOptions: [FABRIC.SceneGraph.OpenGLConstants.GL_BLEND],
        blendModeSfactor: FABRIC.SceneGraph.OpenGLConstants.GL_SRC_ALPHA,
        blendModeDfactor: FABRIC.SceneGraph.OpenGLConstants.GL_ONE_MINUS_SRC_ALPHA,
        parentEventHandler: scene.getSceneRedrawTransparentObjectsEventHandler()
      }).pub;
    if(!options.geometryNode)
      options.geometryNode = scene.constructNode('Plane', {
        width: 16.0,
        height: 10.0,
      }).pub;
      
    var workPlaneNode = scene.constructNode('Instance', options);
    var workPlaneTransformNode = scene.getPrivateInterface(workPlaneNode.pub.getTransformNode());
    var workPlaneTransformDGNode = workPlaneTransformNode.getDGNode();
    workPlaneTransformDGNode.addMember("standing","Boolean",true);
    workPlaneNode.addMemberInterface(workPlaneTransformDGNode, 'standing', true);

    // connect the workplane to the camera and its transform
    var cameraPriv = scene.getPrivateInterface(options.cameraNode);
    var cameraTransformNode = scene.getPrivateInterface(cameraPriv.pub.getTransformNode());
    var cameraTransformDGNode = cameraTransformNode.getDGNode();
    
    workPlaneTransformDGNode.setDependency(cameraTransformDGNode,'camera');
    
    workPlaneTransformDGNode.bindings.append(scene.constructOperator({
      operatorName: 'projectWorkPlane',
      entryFunctionName: 'projectWorkPlane',
      srcFile: 'KL/BulletEditor.kl',
      parameterLayout: [
        'self.globalXfo',
        'camera.globalXfo',
        'camera.target',
        'self.standing'
      ]
    }));

    return workPlaneNode;    
  }});

// load out custom shaders
FABRIC.SceneGraph.defineEffectFromFile('WorkPlaneMaterial', 'WorkPlaneShader.xml');

$(document).ready(function() {
  
  var scene = FABRIC.SceneGraph.createScene();
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer'),
    enableRaycasting: true
  });

  viewport.setBackgroundTextureImage(scene.constructNode('Image', {
    url: '../../BasicDemos/Resources/fabric-demo-gradient.png'
  }));
  
  // Create a camera to draw the scene from
  camera = scene.constructNode('TargetCamera', {
      nearDistance: 1,
      farDistance: 200,
      target: new FABRIC.RT.Vec3(0,2,0),
      position: new FABRIC.RT.Vec3(-1.8, 2.1, 7.93)
    });
  var cameraTransform = camera.getTransformNode();
  scene.constructNode('CameraManipulator', { targetNode: camera });
  viewport.setCameraNode(camera);

  // create the world grid
  scene.constructNode('Instance', {
    geometryNode: scene.constructNode('Grid', {
      size_x: 100.0,
      size_z: 100.0,
      sections_x: 101,
      sections_z: 101
    }),
    materialNode: scene.constructNode('FlatMaterial', {
      color: new FABRIC.RT.rgb(0.5,0.5,0.5,1.0)
    })
  });
  
  var workPlane = scene.constructNode('WorkPlane', {
    cameraNode: camera
  });

  var light = scene.constructNode('PointLight', {
    lightCosCutoff: 5.0,
    transformNode: cameraTransform
  });

  var selectionManager = scene.constructManager('ViewportSelectionManager');
  //var selectionManipulationManager = scene.constructManager('SelectionManipulationManager', {
  //  selectionManager: selectionManager
  //});
  
  //==========================================================
  // MATERIALS + GEOMETRY
  var geometryNodes = {};
  var materialNodes = {};
  geometryNodes['primitiveCube'] = scene.constructNode('Cuboid', {
    length: 1.0,
    width: 1.0,
    height: 1.0
  });
  geometryNodes['primitiveFlat'] = scene.constructNode('Cuboid', {
    length: 3.0,
    width: 0.5,
    height: 1.0
  });
  geometryNodes['primitiveHigh'] = scene.constructNode('Cuboid', {
    length: 0.25,
    width: 2.0,
    height: 0.25
  });
  materialNodes['primitiveCube'] = scene.constructNode('PhongTextureSimpleMaterial', {
    lightNode: light,
    shininess: 50.0,
    diffuseTextureNode: scene.constructNode('Image', { url: '../../BasicDemos/Resources/wood1.png' })
  });
  materialNodes['primitiveFlat'] = scene.constructNode('PhongTextureSimpleMaterial', {
    lightNode: light,
    shininess: 50.0,
    diffuseTextureNode: scene.constructNode('Image', { url: '../../BasicDemos/Resources/wood2.png' })
  });
  materialNodes['primitiveHigh'] = scene.constructNode('PhongTextureSimpleMaterial', {
    lightNode: light,
    shininess: 50.0,
    diffuseTextureNode: scene.constructNode('Image', { url: '../../BasicDemos/Resources/wood3.png' })
  });

  var highlightMaterial = scene.constructNode('OutlineShader', {
    color: FABRIC.RT.rgb(0.6, 0.6, 0.6, 0.5),
    thickness: 0.2
  });
  
  //==========================================================
  // BULLET LOGIC
  var worldNode = scene.constructNode('BulletWorldNode', {groundPlaneSize: 100, substeps: 6});
  
  // create all collision shapes
  var scalings = {};
  scalings['primitiveCube'] = new FABRIC.RT.Vec3(0.5,0.5,0.5);
  scalings['primitiveFlat'] = new FABRIC.RT.Vec3(1.5,0.5,0.25);
  scalings['primitiveHigh'] = new FABRIC.RT.Vec3(0.125,0.125,1.0);
  var masses = {};
  masses['primitiveCube'] = 1.0;
  masses['primitiveFlat'] = 2.0;
  masses['primitiveHigh'] = 0.25;
  for(var id in scalings)
    worldNode.addShape(id,FABRIC.RT.BulletShape.createBox(scalings[id]));

  // function to create a rigid body
  var rigidBodies = {};
  var rigidBodyCount = 0;
  function constructRigidBody(type,xfo,notify) {
    if(!xfo) xfo = new FABRIC.RT.Xfo();
    
    var name = type+'_'+rigidBodyCount;
    if(rigidBodyCount[name])
      return rigidBodyCount[name];
    
    var body = new FABRIC.RT.BulletRigidBody({
      transform: xfo
    });
    
    var transform = scene.constructNode('BulletRigidBodyTransform', {
      bulletWorldNode: worldNode,
      name: name,
      shapeName: type,
      rigidBody: new FABRIC.RT.BulletRigidBody({
          transform: xfo,
          friction: 0.99,
          restitution: 0.05,
          mass: masses[type]
      })
    });
    
    var instance = scene.constructNode('SelectableInstance', {
      geometryNode: geometryNodes[type],
      materialNode: materialNodes[type],
      transformNode: transform,
      enableRaycasting: true,
      highlightMaterial: highlightMaterial,
      selectMaterial: highlightMaterial
    });

    // store it to the map    
    rigidBodies[name] = {};
    rigidBodies[name].name = name;
    rigidBodies[name].type = type;
    rigidBodies[name].transform = transform;
    rigidBodies[name].instance = instance;
    rigidBodies[name].world = worldNode;
    rigidBodyCount++;
    
    if(notify) {
      //todo
      console.log('websocket communication');
    }
    
    return rigidBodies[name];
  }
  
  //==========================================================
  // PLAYBACK CONTROL
  var isPlaying = false;
  $('#play').button({
    text: true,
    icons: {
      primary: 'ui-icon-play'
    }
  }).click(function() {
    var options;
    workPlane.setDrawToggle(isPlaying);
    if(!isPlaying) {
      $(this).button('option', {
        label: 'Pause',
        icons: {
          primary: 'ui-icon-pause'
        }
      });
      isPlaying = true;
      scene.animation.play();
    } else {
      $(this).button('option', {
        label: 'Play',
        icons: {
          primary: 'ui-icon-play'
        }
      });
      isPlaying = false;
      scene.animation.pause();
      setTimeout(function(){
        scene.animation.setTime(0);
        viewport.redraw();
      },10);
    }
  });
  
  //==========================================================
  // UI LOGIC
  function alignCameraWithAxes(alignX,alignY,alignZ) {
    var targetPos = cameraTransform.getTarget();
    var xfo = cameraTransform.getGlobalXfo();
    var distance = targetPos.subtract(xfo.tr).length();
    if(alignX) xfo.tr.x = targetPos.x + 0.0001;
    if(alignY) xfo.tr.y = targetPos.y;
    if(alignZ) xfo.tr.z = targetPos.z;
    xfo.tr = xfo.tr.subtract(targetPos).unit().multiplyScalar(distance).add(targetPos);
    xfo.ori.setFromDirectionAndUpvector(xfo.tr.subtract(targetPos),new FABRIC.RT.Vec3(0,1,0));
    cameraTransform.setGlobalXfo(xfo);
    viewport.redraw();
  }
  $('#workplaneXY').button().click(function() {
    alignCameraWithAxes(true,true,false);
  });
  $('#workplaneYZ').button().click(function() {
    alignCameraWithAxes(false,true,true);
  });
  $('#workplaneXZ').button().click(function() {
    alignCameraWithAxes(true,false,true);
  });
  $('#workplaneStand').button().click(function() {
    workPlane.setStanding(!workPlane.getStanding());
    viewport.redraw();
  });
  $('#workplaneblend').slider({
    min: 0.0,
    max: 1.0,
    step: 0.01,
    value: workPlane.getMaterialNode().getColorBlend()
  }).bind('slide',
    function(event, ui) {
      workPlane.getMaterialNode().setColorBlend(ui.value);
      viewport.redraw();
    }
  );
  
  //===========================================================
  // DRAG AND DROP
  $("#primitiveCube").draggable();
  $("#primitiveFlat").draggable();
  $("#primitiveHigh").draggable();
  
  var dragStatus = {};
  var originalOffset = {};
  
  // setup a function for dragging a 3d rigid body
  var currentRigidBody = undefined;
  var dragConstructedRigidBody = function(evt) {
    if(!currentRigidBody)
      return;
    
    // construct an artifical rayEvent
    var rayEvt = {
      offsetX: evt.pageX,
      offsetY: evt.pageY,
      target: {
        clientWidth: $('#FabricContainer').width()
      }
    };
    
    var planeXfo = workPlane.getTransformNode().getGlobalXfo();
    var cameraXfo = cameraTransform.getGlobalXfo();
    var target = cameraTransform.getTarget();
    var rayData = viewport.rayCast(rayEvt).rayData;
    var distance = FABRIC.RT.Vec3.rayIntersectPlane(rayData.start,rayData.direction,target,planeXfo.ori.getYaxis());
    var xfo = new FABRIC.RT.Xfo();
    xfo.tr = rayData.start.add(rayData.direction.multiplyScalar(distance));
    if(evt.shiftKey) {
      xfo.tr = planeXfo.ori.inverse().rotateVector(xfo.tr.subtract(target));
      xfo.tr.x = Math.floor(xfo.tr.x+0.5)-0.5;
      xfo.tr.y = Math.floor(xfo.tr.y+0.5)-0.5;
      xfo.tr = planeXfo.ori.rotateVector(xfo.tr.add(target));
    }
    xfo.tr.y = xfo.tr.y < scalings[currentRigidBody.type].z ? scalings[currentRigidBody.type].z : xfo.tr.y;
    xfo.ori.setFromDirectionAndUpvector(new FABRIC.RT.Vec3(0,1,0),planeXfo.ori.getYaxis());
    
    worldNode.setRigidBodyInitialTransform(currentRigidBody.name,xfo);
    viewport.redraw();
  };
  
  // define the viewport as a drop target
  $("#FabricContainer").droppable({
    over: function(evt) {
      if(isPlaying)
        return;
      var id = evt.srcElement.getAttribute('id');
      if(dragStatus[id] != 'outside')
        return;
      dragStatus[id] = 'inside';
      
      // update the evt data
      currentRigidBody = constructRigidBody(id);

      dragConstructedRigidBody(evt);
      document.addEventListener('mousemove',dragConstructedRigidBody);
    },
    drop: function(evt) {
      if(isPlaying)
        return;
      var id = evt.srcElement.getAttribute('id');
      if(dragStatus[id] != 'inside')
        return;

      // actual drop
      document.removeEventListener('mousemove',dragConstructedRigidBody);
      currentRigidBody = undefined;
    },
    activate: function(evt) {
      // store the element's offset
      var id = evt.srcElement.getAttribute('id');
      originalOffset[id] = $("#"+id).offset();
      dragStatus[id] = 'outside';
    },
    deactivate: function(evt) {
      // restore the element's offset
      var id = evt.srcElement.getAttribute('id');
      $("#"+id).offset(originalOffset[id]);
      dragStatus[id] = undefined;
    }
  });
  
  $('#loadingDialog').dialog({
    modal: true
  });
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight) {
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if (nbRemaining===0) {
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      viewport.redraw();
      return true;
    }
  });
});

// jQuert UI Styling classes
$(document).ready(function() {
	$(".box").addClass("ui-widget");
	$(".box h2").addClass("ui-widget-header ui-corner-all");
	$(".content").addClass("ui-widget-content");
});

</script>

  </head> 
  <body style="padding: 10px">
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">

      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          <p class="box">&larr; <a href="../../../index.html">back to Demo list</a></p>
          <div class="box">
            <h2>INFO</h2>
            <div class="content">
              Bullet Editor.<br>
              You can use the primitives below to create a bullet simulation world. Use Drag&Drop to place
              primitives on the working plane. You can also drive the distance of the working plane by holding
              Alt and using the mouse wheel. Furthermore use the buttons below to align the camera to on of the
              axes.
            </div><!--content-->
            <h2>WORKPLANE</h2>
            <div class="content">
              <button id="workplaneXY">X-Y</button>
              <button id="workplaneYZ">Y-Z</button>
              <button id="workplaneXZ">X-Z</button>
              <button id="workplaneStand">FIX</button><br>
              <div id="workplaneblend" style="margin-top: 5px"></div>
            </div><!--content-->
            <h2>PRIMITIVES</h2>
            <div class="content">
              <div id="primitiveCube" style="display: inline-block; margin: 5px; width: 50px; height: 50px; background-image:url(../../BasicDemos/Resources/wood1.png)"></div>
              <div id="primitiveFlat" style="display: inline-block; margin: 5px; width: 150px; height: 25px; background-image:url(../../BasicDemos/Resources/wood2.png)"></div>
              <div id="primitiveHigh" style="display: inline-block; margin: 5px; width: 13px; height: 100px; background-image:url(../../BasicDemos/Resources/wood3.png)"></div>
            </div><!--content-->
            <h2>SIMULATION</h2>
            <div class="content button-controls">
              <button id="play">Play</button>
            </div><!--content-->
            </div><!--content-->
          </div><!--box-->
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->  </body> 
  </html>
