<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">  
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
    <title>FABRIC - Bullet Editor</title> 
    
    <script type="text/javascript" src="../../../../ThirdParty/jQuery/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="../../../../ThirdParty/jQuery/jquery-ui-1.8.16.custom.min.js"></script>

    <link type="text/css" href="../../../../ThirdParty/jQuery/css/fabric/main.css" rel="stylesheet" />
    <link type="text/css" href="../../../../ThirdParty/jQuery/css/fabric/jquery-ui-1.8.16.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.WebSocket.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../../SceneGraph/FABRIC.SceneGraph.Persistence.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../../SceneGraph/Parsers/parseOBJ.js" charset="utf-8"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

<style type="text/css">
#sidebar {
  width:280px;
}  
#viewer {
  right:280px;
}
</style>
<script type="text/javascript">

function getUrlVars() {
  var vars = {};
  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
    vars[key] = value;
  });
  return vars;
}

FABRIC.SceneGraph.registerNodeType('WorkPlane', {
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
      color: new FABRIC.RT.rgb(0.1,0.7,0.1,1.0)
    });

    if(!options.cameraNode)
      throw("Options.cameraNode is not specified!");

    // create a color if there's nothing
    if(!options.materialNode)
      options.materialNode = scene.constructNode('FlatMaterial', {
        color: options.color
      }).pub;
    
    var workPlaneNode = scene.constructNode('Instance', options);
    var workPlaneTransformNode = scene.getPrivateInterface(workPlaneNode.pub.getTransformNode());
    var workPlaneTransformDGNode = workPlaneTransformNode.getDGNode();
    
    // connect the workplane to the camera and its transform
    var cameraPriv = scene.getPrivateInterface(options.cameraNode);
    var cameraTransformNode = scene.getPrivateInterface(cameraPriv.pub.getTransformNode());
    var cameraTransformDGNode = cameraTransformNode.getDGNode();
    
    workPlaneTransformDGNode.setDependency(cameraTransformDGNode,'camera');
    
    workPlaneTransformDGNode.bindings.append(scene.constructOperator({
      operatorName: 'projectWorkPlane',
      entryFunctionName: 'projectWorkPlane',
      srcFile: 'KL/BulletEditor.kl',
      parameterLayout: [
        'self.globalXfo',
        'camera.globalXfo',
        'camera.target'
      ]
    }));

    return workPlaneNode;    
  }});

$(document).ready(function() {
  
  var scene = FABRIC.SceneGraph.createScene();
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer')
  });

  viewport.setBackgroundTextureImage(scene.constructNode('Image', {
    url: '../../BasicDemos/Resources/fabric-demo-gradient.png'
  }));
  
  // Create a camera to draw the scene from
  camera = scene.constructNode('TargetCamera', {
      nearDistance: 1,
      farDistance: 200,
      target: new FABRIC.RT.Vec3(0,0,0),
      position: new FABRIC.RT.Vec3(-1.8, 4.77, 7.93)
    });
  var cameraTransform = camera.getTransformNode();
  scene.constructNode('CameraManipulator', { targetNode: camera });
  viewport.setCameraNode(camera);

  // create the world grid
  var worldGridNode = scene.constructNode('Grid', {
    size_x: 100.0,
    size_z: 100.0,
    sections_x: 101,
    sections_z: 101
  });
  var workPlaneGridNode = scene.constructNode('Grid', {
    size_x: 16.0,
    size_z: 10.0,
    sections_x: 17,
    sections_z: 11
  });
  scene.constructNode('Instance', {
    geometryNode: worldGridNode,
    materialNode: scene.constructNode('FlatMaterial', {
      color: new FABRIC.RT.rgb(0.5,0.5,0.5,1.0)
    } )
  });
  scene.constructNode('WorkPlane', {
    cameraNode: camera,
    geometryNode: workPlaneGridNode
  });

  var light = scene.constructNode('PointLight', { position: new FABRIC.RT.Vec3(420.0, 1000.0, 600.0) });
  var phongMaterial = scene.constructNode('PhongMaterial', {
      diffuseColor: FABRIC.RT.rgb(0.8, 0, 0, 1),
      lightNode: light
    });
  
  //==========================================================
  // UI LOGIC
  function alignCameraWithAxes(alignX,alignY,alignZ) {
    var targetPos = cameraTransform.getTarget();
    var xfo = cameraTransform.getGlobalXfo();
    var distance = targetPos.subtract(xfo.tr).length();
    if(alignX) xfo.tr.x = targetPos.x;
    if(alignY) xfo.tr.y = targetPos.y;
    if(alignZ) xfo.tr.z = targetPos.z;
    xfo.tr = xfo.tr.subtract(targetPos).unit().multiplyScalar(distance).add(targetPos);
    xfo.ori.setFromDirectionAndUpvector(xfo.tr.subtract(targetPos),new FABRIC.RT.Vec3(0,1,0));
    cameraTransform.setGlobalXfo(xfo);
    viewport.redraw();
  }
  $('#workplaneXY').button().click(function() {
    alignCameraWithAxes(true,true,false);
  });
  $('#workplaneYZ').button().click(function() {
    alignCameraWithAxes(false,true,true);
  });
  $('#workplaneXZ').button().click(function() {
    alignCameraWithAxes(true,false,true);
  });
  $('#workplaneUnit').button().click(function() {
  });

  $('#loadingDialog').dialog({
    modal: true
  });
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight) {
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if (nbRemaining===0) {
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      viewport.redraw();
      return true;
    }
  });
});

// jQuert UI Styling classes
$(document).ready(function() {
	$(".box").addClass("ui-widget");
	$(".box h2").addClass("ui-widget-header ui-corner-all");
	$(".content").addClass("ui-widget-content");
});

</script>

  </head> 
  <body style="padding: 10px">
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">

      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          <p class="box">&larr; <a href="../../../index.html">back to Demo list</a></p>
          <div class="box">
            <h2>INFO</h2>
            <div class="content">
              Bullet Editor.<br>
              You can use the primitives below to create a bullet simulation world. Use Drag&Drop to place
              primitives on the working plane. You can also drive the distance of the working plane by holding
              Alt and using the mouse wheel. Furthermore use the buttons below to align the camera to on of the
              axes.
            </div><!--content-->
            <h2>WORKPLANE</h2>
            <div class="content">
              <button id="workplaneXY">X-Y</button>
              <button id="workplaneYZ">Y-Z</button>
              <button id="workplaneUnit">UNIT</button>
            </div><!--content-->
          </div><!--box-->
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->  </body> 
  </html>
