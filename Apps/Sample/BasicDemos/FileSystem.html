<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">  
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
    <title>FABRIC - FileSystem</title> 
        
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-ui-1.8.16.custom.min.js"></script>

    <link type="text/css" href="../../../ThirdParty/jQuery/css/fabric/main.css" rel="stylesheet" />
    <link type="text/css" href="../../../ThirdParty/jQuery/css/fabric/jquery-ui-1.8.16.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLRenderTarget.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Images.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/Parsers/parseOBJ.js" charset="utf-8"></script>
    
<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

<style type="text/css">
#sidebar {
  width:300px;
}  
#viewer {
  right:300px;
}
</style>

<script type="text/javascript">

FABRIC.SceneGraph.registerNodeType('FileSystemNode', {
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
      baseFolder: undefined,
      asciiFile: undefined,
      objFile: undefined
    });

    var fsNode = scene.constructNode('SceneGraphNode', options);
    var dgnode = fsNode.constructDGNode('DGNode');
    dgnode.addMember('baseFolder','String', options.baseFolder);
    dgnode.addMember('childFolders','String[]');
    dgnode.addMember('childFiles','String[]');
    
    dgnode.bindings.append(scene.constructOperator({
      operatorName: 'getFolderSubFolders',
      srcFile: 'FABRIC_ROOT/SceneGraph/KL/fileSystem.kl',
      parameterLayout: [
        "self.baseFolder",
        "self.childFolders"
      ],
      entryFunctionName: 'getFolderSubFolders',
      async: false
    }));
    dgnode.bindings.append(scene.constructOperator({
      operatorName: 'getFolderFiles',
      srcFile: 'FABRIC_ROOT/SceneGraph/KL/fileSystem.kl',
      parameterLayout: [
        "self.baseFolder",
        "self.childFiles"
      ],
      entryFunctionName: 'getFolderFiles',
      async: false
    }));
    
    fsNode.pub.getSubFolders = function(folder) {
      if(folder)
        dgnode.setData('baseFolder',0,folder);
      dgnode.evaluate();
      return dgnode.getData('childFolders',0)
    }

    fsNode.pub.getFiles= function(folder) {
      if(folder)
        dgnode.setData('baseFolder',0,folder);
      dgnode.evaluate();
      return dgnode.getData('childFiles',0)
    }

    return fsNode;
  }});    

$(document).ready(function() {

  $('#saveResource').button()

  var scene = FABRIC.SceneGraph.createScene({ preDraw:false, postDraw:false });
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer'),
    backgroundColor: FABRIC.RT.rgb(0.0, 0.05, 0.15)
  });

  viewport.setBackgroundTextureImage(scene.constructNode('Image', {
    url: 'Resources/fabric-demo-gradient.png'
  }));
  
 camera = scene.constructNode('TargetCamera', {
      nearDistance: 1,
      farDistance: 300,
      target: new FABRIC.RT.Vec3(-10, -1.2, -0.15),
      position: new FABRIC.RT.Vec3(-1.8, 4.77, 7.93)
    });

  scene.constructNode('CameraManipulator', { targetNode: camera });

  viewport.setCameraNode(camera);

  var light = scene.constructNode('PointLight', { position: new FABRIC.RT.Vec3(420.0, 1000.0, 600.0) });
  var material = scene.constructNode('PhongMaterial', {
    diffuseColor: FABRIC.RT.rgb(Math.random(), Math.random(), Math.random(), 1),
    lightNode: light
  });

  /*
  var resourceLoadNode = scene.importAssetFile('/development/Fabric/Web/Apps/Sample/BasicDemos/Models/cow.obj', {
    localPath: true
  });
  resourceLoadNode.addEventListener('objparsesuccess', function(evt){
    for(var name in evt.loadedGeometries) {
      scene.constructNode('Instance', {
        geometryNode: evt.loadedGeometries[name],
        materialNode: material,
        transformNode: scene.constructNode('Transform', {
          hierarchical: false,
          globalXfo: new FABRIC.RT.Xfo({ tr: new FABRIC.RT.Vec3(-10, 0, 0) })
        }),
      });
    }
  });
  resourceLoadNode.fireLoadSuccessEvent();
  */
  
  var fsNode = scene.constructNode('FileSystemNode');
  console.log(fsNode.getSubFolders('/home/helge'));
  console.log(fsNode.getFiles('/home/helge'));
  //console.log(localStorageNode.getFileTextContent('/yourfolder/yourtextfile.txt'));
  
  $('#loadingDialog').dialog({
    modal: true
  });
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight) {
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if (nbRemaining===0) {
      $('#loadingDialog').dialog('close');
      viewport.redraw();
      return true;
    }
  });

});

// jQuert UI Styling classes
$(document).ready(function() {
	$(".box").addClass("ui-widget");
	$(".box h2").addClass("ui-widget-header ui-corner-all");
	$(".content").addClass("ui-widget-content");
});

</script>

  </head> 
  <body>
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">

      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          <p class="box">&larr; <a href="../../../index.html">back to Demo list</a></p>
          <div class="box">
            <h2>INFO</h2>
            <div class="content">
              Local Storage.<br>
              This very basic sample shows how to load and save local files using the so called FileSystem node.
              This node is only available on local deployments of Fabric Engine, not on the ones deployed in the
              world wide web.
            </div><!--content-->
          </div><!--box-->
          <div class="box">
            <h2>CONTROLS</h2>
            <div class="content">
              <button id="loadAsciiFile" style="margin-top:10px;">Load Ascii File</button>
            </div><!--content-->
          </div><!--box-->
            
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->
  </body> 
  </html>
