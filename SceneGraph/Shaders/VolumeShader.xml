<?xml version="1.0" encoding="UTF-8"?>
<shader>
	<name>VolumeMaterial</name>
	
  <uniforms>
    <uniform name="u_modelViewProjectionMatrix" constant="modelViewProjectionMatrix" type="Mat44" owner="instance"/>
    <uniform name="u_alphaFactor" constant="alphaFactor" type="Scalar" defaultValue="0.02"/>
    <uniform name="u_transparency" constant="transparency" type="Scalar" defaultValue="1.0"/>
    <uniform name="u_brightness" constant="brightness" type="Scalar" defaultValue="1.0"/>
    <uniform name="u_minOpacity" constant="minOpacity" type="Scalar" defaultValue="0.0"/>
    <uniform name="u_maxOpacity" constant="maxOpacity" type="Scalar" defaultValue="1.0"/>
  </uniforms>

  <attributes>
		<attribute name="a_position" binding="positions"/>
    <attribute name="a_normal" binding="normals"/>
  </attributes>

  <lights>
	</lights>

	<textures>
    <texture binding="opacityTexture"/>
  </textures>

  <openglstateparams>
    <enableOptions>
      <option>GL_BLEND</option>
    </enableOptions>
    <blendModeSfactor>GL_SRC_ALPHA</blendModeSfactor>
    <blendModeDfactor>GL_ONE_MINUS_SRC_ALPHA</blendModeDfactor>
  </openglstateparams>

  <vertexshader>
		<source>
			<![CDATA[
			uniform mat4 u_modelViewProjectionMatrix;
/*			uniform mat4 u_modelViewMatrix;
			uniform vec4 u_lightPosition;
	*/		
			attribute vec4 a_position;
			attribute vec3 a_normal;
/*
			varying vec3 lightDir;
			varying vec3 viewDir;
*/
			void main()
			{
				gl_TexCoord[0].xyz = a_normal.xyz;

/*				vec4 modelCameraPosition = u_modelViewMatrix * a_position;
				lightDir = vec3(u_lightPosition - modelCameraPosition);
				viewDir = vec3(-modelCameraPosition);*/
				gl_Position = u_modelViewProjectionMatrix * a_position;
			}
			]]>
		</source>
	</vertexshader>
	
	<fragmentshader>
		<source>
			<![CDATA[
      uniform float u_alphaFactor;
      uniform float u_transparency;
      uniform float u_brightness;
      uniform float u_minOpacity;
      uniform float u_maxOpacity;
      
/*			uniform int u_lightType;
			uniform vec3 u_lightDir;
			uniform vec4 u_lightColor;
			uniform float u_lightCosCutoff;
			uniform mat3 u_normalMatrix;

			uniform float u_materialShininess;
			uniform vec4 u_materialAmbientColor;
*/
			uniform sampler3D u_samplerOpacityMap;
//			uniform sampler3D u_samplerGradientMap;
/*			
			varying vec3 lightDir;
			varying vec3 viewDir;
*/
			]]>
			<![CDATA[

			void main(){
/*				vec3 Ln = normalize(lightDir);
				vec3 Vn = normalize(viewDir);
*/
        float opacity = 0.0;

        opacity = texture3D( u_samplerOpacityMap, gl_TexCoord[0].xyz).r;
        if(opacity < u_minOpacity || opacity > u_maxOpacity)
          opacity = 0.0;

        if(u_brightness > 0.5)
        {
          if(opacity > 0.0)
            opacity = mix(opacity, 1.0, (u_brightness-0.5)*2.0);
        }
        else
          opacity = mix(0.0, opacity, u_brightness*2.0);

        float color = opacity;//mix(opacity, 1.0, u_transparency);
        float alpha = mix(1.0-u_transparency, opacity * u_alphaFactor, u_transparency );
        if(alpha > 1.0)
          alpha = 1.0;
        if(opacity == 0.0)
          alpha = 0.0;

				gl_FragColor = vec4(color, color, color, alpha );
			}
			]]>
		</source>
	</fragmentshader>
</shader>
